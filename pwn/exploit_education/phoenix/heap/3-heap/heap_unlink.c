/*
 * phoenix/heap-three, by https://exploit.education
 *
 * This level is linked against ftp://gee.cs.oswego.edu/pub/misc/malloc-2.7.2.c
 * version 2.7.2, with a SHA1 sum of 407329d164e4989b59b9a828760acb720dc5c7db
 * more commonly known as "dlmalloc", Doug Lea Malloc
 *
 * Can you hijack flow control, and execute winner()? Afterwards, how
 * about your own code? This level is solvable on Linux i386 easily enough,
 * as for other architectures, it may not be possible, or may require some
 * creativity - let me know what you come up with :)
 *
 * My friend told me that nothing rhymes with orange.
 * I told them, "No, it doesn't".
 *
 * Or, more seriously, https://www.youtube.com/watch?v=lPcR5RVXHMg
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <time.h>
#include <unistd.h>

void winner() {
  printf("Level was successfully completed at @ %ld seconds past the Epoch\n",
         time(NULL));
}

// LiveOverflow - https://www.youtube.com/watch?v=gL45bjQvZSU
// https://blog.lamarranet.com/index.php/exploit-education-phoenix-heap-three-solution
// https://n1ght-w0lf.github.io/binary%20exploitation/heap-three
// https://www.lucas-bader.com/ctf/2019/05/02/heap3

int main(int argc, char **argv) {
  char *a, *b, *c;

  if (argc < 4) {
    printf("Please specify arguments to copy :-)\n");
    exit(1);
  }

  // Allocate 3 chunks of memory
  a = malloc(32);
  b = malloc(32);
  c = malloc(32);

  // Copy 3 params to chunks (buffer overflow)
  strcpy(a, argv[1]);
  strcpy(b, argv[2]);
  strcpy(c, argv[3]);

  // Free the chunks in reverse order
  free(c);
  free(b);
  free(a);

  // We need to replace printf with winner()
  // Remember compiler will replace printf with puts (got.puts)
  printf("dynamite failed?\n");
}